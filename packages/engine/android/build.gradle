apply plugin: 'com.android.library'

group = 'services.session.keyed.engine'
version = '0.1.0'

// ONNX Runtime - Download AAR and extract native libraries
def onnxVersion = "1.21.0"
def onnxAarDir = "$buildDir/onnxruntime"
def onnxAarSha256 = "8b675e9680b8cc02dca706a5e3b4e35cc8506de5bdf206fdae68081cbd804414"

def sha256 = { File file ->
	def digest = java.security.MessageDigest.getInstance("SHA-256")
	file.withInputStream { stream ->
		byte[] buffer = new byte[8192]
		int bytesRead
		while ((bytesRead = stream.read(buffer)) != -1) {
			digest.update(buffer, 0, bytesRead)
		}
	}
	return digest.digest().collect { String.format("%02x", it) }.join("")
}

task downloadOnnxRuntime {
    doLast {
        def aarFile = file("$onnxAarDir/onnxruntime.aar")
        def shouldDownload = !aarFile.exists()
        if (!shouldDownload) {
            def existingHash = sha256(aarFile)
            shouldDownload = existingHash != onnxAarSha256
            if (shouldDownload) {
                logger.lifecycle("ONNX Runtime checksum mismatch, re-downloading AAR")
                aarFile.delete()
            }
        }
        if (shouldDownload) {
            mkdir onnxAarDir
            def url = "https://repo1.maven.org/maven2/com/microsoft/onnxruntime/onnxruntime-android/$onnxVersion/onnxruntime-android-$onnxVersion.aar"
            ant.get(src: url, dest: aarFile, usetimestamp: true)
        }

        def actualHash = sha256(aarFile)
        if (actualHash != onnxAarSha256) {
            aarFile.delete()
            throw new GradleException("ONNX Runtime checksum verification failed. Expected $onnxAarSha256, got $actualHash")
        }
    }
}

task extractOnnxRuntime(dependsOn: downloadOnnxRuntime) {
    doLast {
        def extractDir = file("$onnxAarDir/extracted")
        if (!extractDir.exists()) {
            copy {
                from zipTree("$onnxAarDir/onnxruntime.aar")
                into extractDir
            }
        }
    }
}

// Copy ONNX model to assets
task copyModelToAssets(type: Copy) {
    from "$projectDir/../models"
    into "$projectDir/src/main/assets"
    include "*.onnx"
}

preBuild.dependsOn copyModelToAssets

tasks.matching { it.name.startsWith('externalNativeBuild') }.configureEach {
    dependsOn extractOnnxRuntime
}

def expoModulesCorePlugin = new File(project(":expo-modules-core").projectDir.absolutePath, "ExpoModulesCorePlugin.gradle")
apply from: expoModulesCorePlugin
applyKotlinExpoModulesCorePlugin()
useCoreDependencies()
useExpoPublishing()

// If you want to use the managed Android SDK versions from expo-modules-core, set this to true.
// The Android SDK versions will be bumped from time to time in SDK releases and may introduce breaking changes in your module code.
// Most of the time, you may like to manage the Android SDK versions yourself.
def useManagedAndroidSdkVersions = false
if (useManagedAndroidSdkVersions) {
  useDefaultAndroidSdkVersions()
} else {
  buildscript {
    // Simple helper that allows the root project to override versions declared by this library.
    ext.safeExtGet = { prop, fallback ->
      rootProject.ext.has(prop) ? rootProject.ext.get(prop) : fallback
    }
  }
  project.android {
    compileSdkVersion safeExtGet("compileSdkVersion", 36)
    defaultConfig {
      minSdkVersion safeExtGet("minSdkVersion", 24)
      targetSdkVersion safeExtGet("targetSdkVersion", 36)
    }
  }
}

android {
  namespace "services.session.keyed.engine"
  defaultConfig {
    versionCode 1
    versionName "0.1.0"

    // Enable CMake for C++ native code
    externalNativeBuild {
      cmake {
        cppFlags "-std=c++17 -O3 -ffast-math"
        arguments "-DANDROID_STL=c++_shared",
                  "-DONNX_DIR=${buildDir}/onnxruntime/extracted"
      }
    }

    ndk {
      abiFilters "armeabi-v7a", "arm64-v8a", "x86", "x86_64"
    }
  }

  externalNativeBuild {
    cmake {
      path "src/main/cpp/CMakeLists.txt"
      version "3.22.1"
    }
  }

  lintOptions {
    abortOnError false
  }

  // Package ONNX Runtime native libraries
  sourceSets {
    main {
      jniLibs.srcDirs = ["$buildDir/onnxruntime/extracted/jni"]
    }
  }
}
